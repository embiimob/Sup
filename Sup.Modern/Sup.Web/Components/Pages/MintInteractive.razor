@page "/mint-interactive"
@rendermode InteractiveServer
@using Sup.Core.Services
@using Sup.Core.Models
@inject IBlockchainService BlockchainService
@inject IIpfsService IpfsService
@inject IWalletService WalletService

<PageTitle>Sup!? - Create</PageTitle>

<div class="mint-container">
    <div class="mint-header">
        <h1>‚ú® Create</h1>
        <p>Mint objects, profiles, and inquiries on the blockchain</p>
    </div>

    <div class="mint-type-selector">
        <button class="type-card @(selectedType == "object" ? "active" : "")" @onclick='() => SelectType("object")'>
            <div class="type-icon">üé®</div>
            <h3>Object</h3>
            <p>Create a blockchain object or NFT</p>
        </button>
        <button class="type-card @(selectedType == "profile" ? "active" : "")" @onclick='() => SelectType("profile")'>
            <div class="type-icon">üë§</div>
            <h3>Profile</h3>
            <p>Register or update your profile</p>
        </button>
        <button class="type-card @(selectedType == "inquiry" ? "active" : "")" @onclick='() => SelectType("inquiry")'>
            <div class="type-icon">‚ÅâÔ∏è</div>
            <h3>Inquiry</h3>
            <p>Create a poll or question</p>
        </button>
    </div>

    @if (selectedType == "object")
    {
        <div class="mint-form">
            <h2>üé® Mint Object</h2>
            
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="status-message @statusClass">
                    @statusMessage
                </div>
            }

            <div class="form-row">
                <div class="form-group">
                    <label>Object Name *</label>
                    <input type="text" @bind="objectName" class="input-field" placeholder="My Digital Artwork" />
                </div>
                <div class="form-group">
                    <label>URN (Unique Resource Name) *</label>
                    <input type="text" @bind="objectUrn" class="input-field" placeholder="my-artwork-2024" />
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea @bind="objectDescription" class="input-field" rows="4" placeholder="Describe your object..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Creator Address</label>
                    <input type="text" @bind="objectCreator" class="input-field" placeholder="Auto-generated or paste address" />
                    <button class="inline-btn" @onclick="GenerateCreatorAddress">Generate New</button>
                </div>
                <div class="form-group">
                    <label>Object Address *</label>
                    <input type="text" @bind="objectAddress" class="input-field" placeholder="Auto-generated or paste address" />
                    <button class="inline-btn" @onclick="GenerateObjectAddress">Generate New</button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Owner Address</label>
                    <input type="text" @bind="objectOwner" class="input-field" placeholder="Owner's blockchain address" />
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" @bind="objectQuantity" class="input-field" />
                </div>
            </div>

            <div class="form-group">
                <label>Keywords (comma separated)</label>
                <input type="text" @bind="objectKeywords" class="input-field" placeholder="art, nft, digital" />
            </div>

            <div class="form-group">
                <label>Blockchain</label>
                <select @bind="selectedBlockchain" class="input-field">
                    <option value="BitcoinTestnet">Bitcoin Testnet</option>
                    <option value="LitecoinMainnet">Litecoin Mainnet</option>
                    <option value="DogecoinMainnet">Dogecoin Mainnet</option>
                </select>
            </div>

            <div class="file-upload-section">
                <div class="upload-box">
                    <div class="upload-icon">üìÅ</div>
                    <h4>Upload Files</h4>
                    <p>Files will be uploaded to IPFS</p>
                    <InputFile OnChange="HandleFileSelected" class="file-input" />
                    @if (selectedFile != null)
                    {
                        <p class="file-selected">Selected: @selectedFile.Name (@FormatFileSize(selectedFile.Size))</p>
                    }
                </div>
                <div class="ipfs-options">
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="uploadToIpfs" />
                        <span>Upload to IPFS</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" @bind="pinToLocal" />
                        <span>Pin to local node</span>
                    </label>
                </div>
                @if (!string.IsNullOrEmpty(ipfsCid))
                {
                    <div class="ipfs-result">
                        ‚úì Uploaded to IPFS: <code>@ipfsCid</code>
                    </div>
                }
            </div>

            <div class="action-buttons">
                <button class="secondary-btn" @onclick="ClearObjectForm">Clear</button>
                <button class="primary-btn" @onclick="MintObject" disabled="@isMinting">
                    @(isMinting ? "Minting..." : "üì¢ Mint Object")
                </button>
            </div>
        </div>
    }
    else if (selectedType == "profile")
    {
        <div class="mint-form">
            <h2>üë§ Register Profile</h2>
            
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="status-message @statusClass">
                    @statusMessage
                </div>
            }

            <div class="form-group">
                <label>URN (Username) *</label>
                <input type="text" @bind="profileUrn" class="input-field" placeholder="embii4u" />
                <small>Your unique identifier on the network</small>
            </div>

            <div class="form-group">
                <label>Profile Address *</label>
                <input type="text" @bind="profileAddress" class="input-field" placeholder="Auto-generated or paste address" />
                <button class="inline-btn" @onclick="GenerateProfileAddress">Generate New</button>
                <small>The blockchain address for your profile</small>
            </div>

            <div class="form-group">
                <label>Display Name</label>
                <input type="text" @bind="profileDisplayName" class="input-field" placeholder="Your Name" />
            </div>

            <div class="form-group">
                <label>Avatar URL</label>
                <input type="text" @bind="profileAvatarUrl" class="input-field" placeholder="ipfs://... or https://..." />
            </div>

            <div class="form-group">
                <label>Bio</label>
                <textarea @bind="profileBio" class="input-field" rows="4" placeholder="Tell people about yourself..."></textarea>
            </div>

            <div class="form-group">
                <label>Website / Links</label>
                <input type="text" @bind="profileWebsite" class="input-field" placeholder="https://yourwebsite.com" />
            </div>

            <div class="form-group">
                <label>Keywords</label>
                <input type="text" @bind="profileKeywords" class="input-field" placeholder="artist, creator, developer" />
            </div>

            <div class="form-group">
                <label>Blockchain</label>
                <select @bind="selectedBlockchain" class="input-field">
                    <option value="BitcoinTestnet">Bitcoin Testnet</option>
                    <option value="LitecoinMainnet">Litecoin Mainnet</option>
                    <option value="DogecoinMainnet">Dogecoin Mainnet</option>
                </select>
            </div>

            <div class="info-box">
                ‚ÑπÔ∏è Profile registrations are valid for 10 years from the last update. After 10 years of inactivity, the URN can be claimed by others.
            </div>

            <div class="action-buttons">
                <button class="secondary-btn" @onclick="ClearProfileForm">Clear</button>
                <button class="primary-btn" @onclick="MintProfile" disabled="@isMinting">
                    @(isMinting ? "Registering..." : "üìù Register Profile")
                </button>
            </div>
        </div>
    }
    else if (selectedType == "inquiry")
    {
        <div class="mint-form">
            <h2>‚ÅâÔ∏è Create Inquiry</h2>
            <p class="coming-soon">Inquiry creation coming soon! This will allow you to create polls and questions on the blockchain.</p>
        </div>
    }
</div>

@code {
    private string selectedType = "object";
    private string selectedBlockchain = "BitcoinTestnet";
    
    // Object fields
    private string objectName = "";
    private string objectUrn = "";
    private string objectDescription = "";
    private string objectCreator = "";
    private string objectAddress = "";
    private string objectOwner = "";
    private decimal objectQuantity = 1;
    private string objectKeywords = "";
    
    // Profile fields
    private string profileUrn = "";
    private string profileAddress = "";
    private string profileDisplayName = "";
    private string profileAvatarUrl = "";
    private string profileBio = "";
    private string profileWebsite = "";
    private string profileKeywords = "";
    
    // File upload
    private IBrowserFile? selectedFile = null;
    private bool uploadToIpfs = true;
    private bool pinToLocal = true;
    private string ipfsCid = "";
    
    // Status
    private bool isMinting = false;
    private string statusMessage = "";
    private string statusClass = "";

    private void SelectType(string type)
    {
        selectedType = type;
        ClearStatus();
    }

    private async Task GenerateCreatorAddress()
    {
        try
        {
            objectCreator = await WalletService.GetNewAddressAsync(selectedBlockchain);
            ShowStatus("‚úì New creator address generated", "success");
        }
        catch (Exception ex)
        {
            ShowStatus($"‚úó Failed to generate address: {ex.Message}", "error");
        }
    }

    private async Task GenerateObjectAddress()
    {
        try
        {
            objectAddress = await WalletService.GetNewAddressAsync(selectedBlockchain);
            ShowStatus("‚úì New object address generated", "success");
        }
        catch (Exception ex)
        {
            ShowStatus($"‚úó Failed to generate address: {ex.Message}", "error");
        }
    }

    private async Task GenerateProfileAddress()
    {
        try
        {
            profileAddress = await WalletService.GetNewAddressAsync(selectedBlockchain);
            ShowStatus("‚úì New profile address generated", "success");
        }
        catch (Exception ex)
        {
            ShowStatus($"‚úó Failed to generate address: {ex.Message}", "error");
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        
        if (uploadToIpfs && selectedFile != null)
        {
            try
            {
                ShowStatus("Uploading to IPFS...", "info");
                
                // Check if IPFS is running
                if (!await IpfsService.IsRunningAsync())
                {
                    ShowStatus("‚ö† IPFS daemon is not running. Please start it in Settings.", "warning");
                    return;
                }
                
                // Upload file
                using var stream = selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); // 50MB max
                var buffer = new byte[selectedFile.Size];
                await stream.ReadAsync(buffer);
                
                ipfsCid = await IpfsService.AddDataAsync(buffer);
                
                if (pinToLocal)
                {
                    await IpfsService.PinAsync(ipfsCid);
                }
                
                ShowStatus($"‚úì File uploaded to IPFS: {ipfsCid}", "success");
            }
            catch (Exception ex)
            {
                ShowStatus($"‚úó IPFS upload failed: {ex.Message}", "error");
            }
        }
    }

    private async Task MintObject()
    {
        if (string.IsNullOrWhiteSpace(objectName) || string.IsNullOrWhiteSpace(objectAddress))
        {
            ShowStatus("‚úó Please fill in all required fields (Name and Address)", "error");
            return;
        }

        isMinting = true;
        ClearStatus();

        try
        {
            // Check blockchain connection
            if (!await BlockchainService.IsConnectedAsync(selectedBlockchain))
            {
                ShowStatus($"‚úó Not connected to {selectedBlockchain}. Please check Settings.", "error");
                return;
            }

            ShowStatus("Creating blockchain object...", "info");

            var obj = new BlockchainObject
            {
                Name = objectName,
                Urn = objectUrn,
                Description = objectDescription,
                Creator = objectCreator,
                Address = objectAddress,
                Owner = string.IsNullOrWhiteSpace(objectOwner) ? objectAddress : objectOwner,
                Quantity = objectQuantity,
                Keywords = objectKeywords.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(k => k.Trim()).ToList(),
                ImageUrl = !string.IsNullOrEmpty(ipfsCid) ? $"ipfs://{ipfsCid}" : "",
                CreatedDate = DateTime.UtcNow
            };

            var txId = await BlockchainService.MintObjectAsync(obj, selectedBlockchain);
            
            ShowStatus($"‚úì Object minted successfully! Transaction ID: {txId}", "success");
            
            // Clear form after successful mint
            await Task.Delay(2000);
            ClearObjectForm();
        }
        catch (Exception ex)
        {
            ShowStatus($"‚úó Minting failed: {ex.Message}", "error");
        }
        finally
        {
            isMinting = false;
        }
    }

    private async Task MintProfile()
    {
        if (string.IsNullOrWhiteSpace(profileUrn) || string.IsNullOrWhiteSpace(profileAddress))
        {
            ShowStatus("‚úó Please fill in all required fields (URN and Address)", "error");
            return;
        }

        isMinting = true;
        ClearStatus();

        try
        {
            // Check blockchain connection
            if (!await BlockchainService.IsConnectedAsync(selectedBlockchain))
            {
                ShowStatus($"‚úó Not connected to {selectedBlockchain}. Please check Settings.", "error");
                return;
            }

            ShowStatus("Registering profile on blockchain...", "info");

            var profile = new Profile
            {
                Urn = profileUrn,
                Address = profileAddress,
                DisplayName = profileDisplayName,
                AvatarUrl = profileAvatarUrl,
                Bio = profileBio,
                Links = new List<string> { profileWebsite },
                RegisteredDate = DateTime.UtcNow,
                LastModified = DateTime.UtcNow
            };

            var txId = await BlockchainService.MintProfileAsync(profile, selectedBlockchain);
            
            ShowStatus($"‚úì Profile registered successfully! Transaction ID: {txId}", "success");
            
            // Clear form after successful mint
            await Task.Delay(2000);
            ClearProfileForm();
        }
        catch (Exception ex)
        {
            ShowStatus($"‚úó Registration failed: {ex.Message}", "error");
        }
        finally
        {
            isMinting = false;
        }
    }

    private void ClearObjectForm()
    {
        objectName = "";
        objectUrn = "";
        objectDescription = "";
        objectCreator = "";
        objectAddress = "";
        objectOwner = "";
        objectQuantity = 1;
        objectKeywords = "";
        selectedFile = null;
        ipfsCid = "";
        ClearStatus();
    }

    private void ClearProfileForm()
    {
        profileUrn = "";
        profileAddress = "";
        profileDisplayName = "";
        profileAvatarUrl = "";
        profileBio = "";
        profileWebsite = "";
        profileKeywords = "";
        ClearStatus();
    }

    private void ShowStatus(string message, string className)
    {
        statusMessage = message;
        statusClass = className;
    }

    private void ClearStatus()
    {
        statusMessage = "";
        statusClass = "";
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
